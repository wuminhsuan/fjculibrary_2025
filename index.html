<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>輔大圖書館 WebAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.3/dist/mindar-image-aframe.prod.js"></script>
<style>
  html,body{
    margin:0;height:100%;overflow:hidden;
    background:#fff;
    font-family:"Noto Sans TC","Microsoft JhengHei","PingFang TC",sans-serif;
  }

  /* ===== 載入緩衝畫面 ===== */
  #splash{
    position:fixed; inset:0; z-index:2000; background:#fff;
    display:grid; place-items:center; transition:opacity .35s ease;
  }
  #splash .box{display:grid; place-items:center; gap:10px}
  #splash img{width:min(42vw,200px); height:auto; user-select:none}
  #splash .txt{font-size:14px; color:#333; letter-spacing:.1em}

  /* ===== 第1層：首頁 ===== */
  #landing{
    position:fixed; inset:0; z-index:1000;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    background:#fff;
  }

  /* 上方操作說明（與首頁圖分層） */
  #topHint{
    text-align:center;
    font-weight:600;
    font-size:15px;
    line-height:1.6;
    color:#333;
    font-family:"Noto Sans TC","Microsoft JhengHei","PingFang TC",sans-serif;
    margin-bottom:12px;
    background:rgba(255,255,255,0.9);
    border-radius:12px;
    padding:10px 20px;
    box-shadow:0 2px 6px rgba(0,0,0,0.05);
  }

  /* 中間圖區 */
  #posterWrap{position:relative;width:min(92vw,960px);aspect-ratio:3/2;}
  #poster{position:absolute;inset:0;width:100%;height:100%;object-fit:contain;border-radius:16px;box-shadow:0 6px 22px rgba(0,0,0,.12)}

  /* 透明可點區 */
  .hotspot{
    position:absolute; transform:translate(-50%,-50%);
    border:none; background:rgba(0,0,0,0); cursor:pointer; padding:0;
    width:32%; height:32%;
  }
  .hs-mb{left:23%; top:28%;}
  .hs-ab{left:77%; top:28%;}
  .hs-fs{left:23%; top:72%;}
  .hs-sb{left:77%; top:72%;}

  /* ===== 第2層：AR ===== */
  #arLayer{position:fixed;inset:0;z-index:1;display:none;background:transparent}
  a-scene{position:fixed;inset:0;width:100vw;height:100vh;background:transparent !important}
  video,canvas,.a-canvas,.mindar-ui-overlay,.mindar-ui-scanning,.mindar-ui-loading{
    position:fixed !important;left:0 !important;top:0 !important;width:100vw !important;height:100vh !important;object-fit:cover !important;background:transparent !important
  }
  .a-enter-vr{display:none !important}

  #backBtn{position:fixed;left:12px;top:12px;z-index:1200;display:none;background:rgba(0,0,0,.6);color:#fff;border:0;border-radius:8px;padding:8px 12px;font-size:14px}

  #scanOverlay{position:fixed;inset:0;z-index:1100;display:none;background:transparent;pointer-events:none;display:grid;place-items:center;}
  #scanOverlay img{width:min(80vw,420px);height:auto;opacity:.95;animation:scanPulse 2s ease-in-out infinite;}
  @keyframes scanPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}

  img[src=""], img:not([src]) { display:none !important; }
</style>
</head>
<body>

<!-- 載入緩衝畫面 -->
<div id="splash" aria-hidden="true">
  <div class="box">
    <img src="./assets/qrcode_guide.png" alt="Loading"/>
    <div class="txt">載入中…</div>
  </div>
</div>

<!-- 第1層：首頁 -->
<section id="landing" aria-label="首頁">
  <!-- 操作說明置於上方 -->
  <div id="topHint">
    操作說明<br>
    在濟時樓各樓層找到學院寶寶，<br>
對準各學院專屬寶寶掃描，<br>
就可以開啟學院專屬通關問題！
<br>

  </div>

  <!-- 中間圖區 -->
  <div id="posterWrap">
    <img id="poster" src="./assets/landing.jpg" alt="請點選館別開始掃描"/>
    <button class="hotspot hs-mb" data-index="1" aria-label="國璽樓"></button>
    <button class="hotspot hs-ab" data-index="0" aria-label="公博樓"></button>
    <button class="hotspot hs-sb" data-index="2" aria-label="濟時樓"></button>
    <button class="hotspot hs-fs" data-index="3" aria-label="舒德樓"></button>
  </div>
</section>

<!-- 返回與第二層 -->
<button id="backBtn">返回首頁</button>
<div id="arLayer">
  <div id="scanOverlay"><img id="scanImg" alt=""></div>

  <a-scene id="scene"
    mindar-image="imageTargetSrc: ./targets.mind?v=75; maxTrack:1; filterMinCF:0.0001; filterBeta:0.05; missTolerance:10; warmupTolerance:5; uiScanning:no; uiLoading:no; uiError:no"
    embedded color-space="sRGB"
    renderer="colorManagement:true; physicallyCorrectLights:true; antialias:true; alpha:true;"
    vr-mode-ui="enabled:false" device-orientation-permission-ui="enabled:false">

    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>
    <a-entity id="t0" mindar-image-target="targetIndex:0"><a-plane width="1" height="0.6" material="opacity:0.001"></a-plane></a-entity>
    <a-entity id="t1" mindar-image-target="targetIndex:1"><a-plane width="1" height="0.6" material="opacity:0.001"></a-plane></a-entity>
    <a-entity id="t2" mindar-image-target="targetIndex:2"><a-plane width="1" height="0.6" material="opacity:0.001"></a-plane></a-entity>
    <a-entity id="t3" mindar-image-target="targetIndex:3"><a-plane width="1" height="0.6" material="opacity:0.001"></a-plane></a-entity>
    <a-entity light="type:ambient; intensity:0.9"></a-entity>
    <a-entity light="type:directional; intensity:0.8" position="0 1 0"></a-entity>
  </a-scene>
</div>

<script>
window.addEventListener('load', ()=>{
  const s=document.getElementById('splash');
  s.style.opacity='0'; setTimeout(()=>s.style.display='none',380);
});

const TXT_FILE={0:'ab',1:'mb',2:'sb',3:'Fr. Schütte'};
const SCAN_IMG={0:'AB',1:'MB',2:'SB',3:'Fr. Schütte'};
const landing=document.getElementById('landing');
const arLayer=document.getElementById('arLayer');
const sceneEl=document.getElementById('scene');
const backBtn=document.getElementById('backBtn');
const scanOv=document.getElementById('scanOverlay');
const scanImgEl=document.getElementById('scanImg');
let selectedIndex=null,navigated=false;

async function getLinkFromTxt(idx){
  const name=TXT_FILE[idx];
  const url=`./Function/${encodeURIComponent(name)}.txt?v=${Date.now()}`;
  const res=await fetch(url);
  if(!res.ok)throw new Error(`讀取失敗：${url}`);
  const text=(await res.text()).split(/\r?\n/).map(s=>s.trim()).find(s=>s.length>0);
  if(!text)throw new Error(`${name}.txt 內容為空`);
  return text;
}
function showScannerBed(idx){
  const key=SCAN_IMG[idx];
  scanImgEl.src=`./scanner%20bed/${encodeURIComponent(key)}.png?v=${Date.now()}`;
  scanOv.style.display='grid';
}
function hideScannerBed(){scanOv.style.display='none';}

document.querySelectorAll('.hotspot').forEach(btn=>{
  btn.addEventListener('click',()=>{
    selectedIndex=parseInt(btn.dataset.index,10);
    showScannerBed(selectedIndex);
    arLayer.style.display='block'; backBtn.style.display='block'; landing.style.display='none';
    const sys=sceneEl.systems['mindar-image-system']; if(sys?.start)sys.start();
  });
});
backBtn.addEventListener('click',()=>{
  try{sceneEl.systems['mindar-image-system']?.stop?.();}catch(e){}
  arLayer.style.display='none'; backBtn.style.display='none'; landing.style.display='flex';
  navigated=false; selectedIndex=null; hideScannerBed();
});
['t0','t1','t2','t3'].forEach((id,idx)=>{
  const anchor=document.getElementById(id);
  anchor.addEventListener('targetFound',async()=>{
    if(navigated||selectedIndex!==idx)return;
    hideScannerBed(); navigated=true;
    try{
      const link=await getLinkFromTxt(idx);
      sceneEl.systems['mindar-image-system']?.stop?.();
      location.href=link;
    }catch(e){
      alert(`無法讀取跳轉連結：${e.message}`);
      navigated=false; showScannerBed(selectedIndex);
    }
  });
  anchor.addEventListener('targetLost',()=>{
    if(!navigated&&selectedIndex===idx)showScannerBed(selectedIndex);
  });
});
fetch('./targets.mind?v=75',{method:'HEAD'})
.then(r=>{if(!r.ok)alert('找不到 targets.mind，請確認檔案與路徑同層。');})
.catch(()=>alert('targets.mind 載入失敗。'));
</script>
</body>
</html>

